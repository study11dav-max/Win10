name: Persistent macOS VNC via Tailscale

on:
  workflow_dispatch:

jobs:
  secure-vnc:
    runs-on: macos-latest
    timeout-minutes: 3600

    steps:
    # -------------------------------
    # 1. Create VNC user (simple password)
    # -------------------------------
    - name: Create VNC user
      shell: bash
      run: |
        VNC_PASS="Welcome@1"

        sudo sysadminctl -addUser vncuser \
          -fullName "VNC User" \
          -password "$VNC_PASS" \
          -admin

        echo "VNC_USER=vncuser" >> "$GITHUB_ENV"
        echo "VNC_PASS=$VNC_PASS" >> "$GITHUB_ENV"

    # -------------------------------
    # 2. Install Tailscale
    # -------------------------------
    - name: Install Tailscale
      shell: bash
      run: |
        brew install --cask tailscale || true
        tailscale version || true

    # -------------------------------
    # 3. Connect to Tailscale
    # -------------------------------
    - name: Tailscale Up
      shell: bash
      run: |
        sudo tailscale up \
          --authkey="${{ secrets.TAILSCALE_AUTH_KEY }}" \
          --hostname=gh-vnc-${{ github.run_id }}

        TS_IP=$(tailscale ip -4 | head -n1)
        echo "TS_IP=$TS_IP" >> "$GITHUB_ENV"

    # -------------------------------
    # 4. Enable Screen Sharing (VNC)
    # -------------------------------
    - name: Enable Screen Sharing
      shell: bash
      run: |
        KICK="/System/Library/CoreServices/RemoteManagement/ARDAgent.app/Contents/Resources/kickstart"

        sudo "$KICK" -activate -restart -agent
        sudo "$KICK" -configure -access -on -users vncuser -privs -all
        sudo "$KICK" -configure -clientopts -setvnclegacy -vnclegacy yes
        sudo "$KICK" -configure -clientopts -setvncpw -vncpw "$VNC_PASS"

    # -------------------------------
    # 5. Show connection info
    # -------------------------------
    - name: VNC Info
      shell: bash
      run: |
        echo "=============================="
        echo "VNC IP   : $TS_IP"
        echo "USER     : vncuser"
        echo "PASS     : Welcome@1"
        echo "VNC URL  : vnc://$TS_IP:5900"
        echo "=============================="

    # -------------------------------
    # 6. Keep session alive
    # -------------------------------
    - name: Keep Alive
      shell: bash
      run: |
        while true; do
          echo "[KEEP ALIVE] $(date)"
          sleep 300
        done
